<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>API Methods</title>
</head>

<body>
  <hr>
  <h1>API Methods</h1>
  <hr>
  <div id="info">
    <button id="info" onclick="getInfo()">App Info</button>
    <button id="version" onclick="getVersion()">App Version</button>
    <button id="health" onclick="healthCheck()">Health Check</button>
    <button id="orders" onclick="getOrders()">Get Orders</button>
    <button id="stock" onclick="getStock()">Get Stock</button>
    <button id="customers" onclick="getCustomers()">Get Customers</button>
    <button id="testdata" onclick="getTestData()">Run Test</button>
    <button id="tabledata" onclick="tableData()">Table Data</button>
  </div>
  <br><br>
  <h3>Response</h3>
  <div id="response"
    style="border:solid;font-family:Cursive,Lucida Handwriting;font-size:15px;background-color:#ABBAEA">
  </div>
  <table id="printData" border="1"></table>
  <br><br>
  <h3>Error</h3>
  <div id="error" style="border:solid;font-family:Cursive,Lucida Handwriting;font-size:15px;background-color:#f0110a">
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script type="text/javascript">
    async function blankAll() {
      const responseContainer = document.getElementById('response');
      const errorContainer = document.getElementById('error');
      $("#printData").empty(); 
      responseContainer.innerText = "";
      errorContainer.innerText = "";
    }

    async function displayResponse(response, error = false) {
      await blankAll();
      const jsonResponse = await response.json();
      const responseContainer = document.getElementById('response');
      const errorContainer = document.getElementById('error');
      if (error) {
        errorContainer.innerText = JSON.stringify(jsonResponse, null, 2);
      } else {
        responseContainer.innerText = JSON.stringify(jsonResponse, null, 2);
      }
    }

    async function displayError(response) {
      displayResponse(response, true)
    }

    async function runCmd(cmd,tableData=false) {
      let response = null;
      try {
        await blankAll();
        const url = window.location.pathname + window.location.search;
        response = await fetch(url + cmd);
        if (response.ok) {
          if (tableData) {
            const jsonResponse = await response.json();
            await buildTable("#printData",jsonResponse);
          } else {
            displayResponse(response);
          }
        } else {
          displayError(response);
        }
      } catch (error) {
        displayError(response);
      }
    }

    async function getInfo() {
      runCmd('info')
    }

    async function getVersion() {
      runCmd('version')
    }

    async function healthCheck() {
      runCmd('healthz')
    }

    async function getOrders() {
      runCmd('orders',true);
    }

    async function getStock() {
      runCmd('stock',true);
    }

    async function getCustomers() {
      runCmd('customers',true);
    }

    async function getTestData() {
      runCmd('testData');
    }

    async function tableData() {
      runCmd('testData',true);
    }

    async function buildTable(tableName,data) {
      $(tableName).empty(); 
      var columns = await addColumnHeaders(tableName,data);
      for (var i = 0; i < data.length; i++) {
        var row = $('<tr/>');
        for (var colIndex = 0; colIndex < columns.length; colIndex++) {
          var cellValue = data[i][columns[colIndex]];
          if (cellValue == null) cellValue = "";
          row.append($('<td/>').html(cellValue));
        }
        $(tableName).append(row);
      }
    }

    async function addColumnHeaders(tableName,data) {
      var columnSet = [];
      var headerTr$ = $('<tr/>');

      for (var i = 0; i < data.length; i++) {
        var rowHash = data[i];
        for (var key in rowHash) {
          if ($.inArray(key, columnSet) == -1) {
            columnSet.push(key);
            headerTr$.append($('<th/>').html(key));
          }
        }
      }
      $(tableName).append(headerTr$);
      return columnSet;
    }
  </script>

</body>

</html>