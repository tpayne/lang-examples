<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Agent Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Add some padding or margin if needed so the floating icon doesn't cover content */
            padding-bottom: 80px; /* Example: make space for the icon */
        }

        .intro_text {
            margin-left: 10px; /* Re-introduced the left margin */
            margin-right: 280px; /* Add right margin to prevent overlap with closed chat window */
            padding: 20px; /* Add some padding */
            /* This text might not be needed when the chat is an overlay,
               you can decide to hide it or keep it on the main page */
        }

        /* Style for the new content section */
        .generative-ai-info {
            margin: 20px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #ffffff;
            line-height: 1.6; /* Improve readability */
            margin-right: 280px; /* Add right margin to prevent overlap with closed chat window */
        }

        .generative-ai-info h2 {
            color: #3b82f6; /* Match header color */
            margin-top: 0;
            margin-bottom: 15px;
        }

         .generative-ai-info ul {
            list-style: disc inside; /* Use bullet points */
            padding-left: 20px; /* Indent the list */
            margin-top: 15px;
        }

         .generative-ai-info li {
            margin-bottom: 8px;
        }


        /* --- Chatbot Widget Container --- */
        #chatbot-widget-container {
            position: fixed; /* Fixed position on the screen */
            bottom: 20px;    /* 20px from the bottom */
            right: 20px;     /* 20px from the right */
            z-index: 1000;   /* Ensure it's above other content */
        }

        /* --- Chat Icon Styles --- */
        #chat-icon {
            width: 60px;     /* Size of the icon */
            height: 60px;
            background-color: #3b82f6; /* Blue background */
            color: white;    /* Icon color */
            border-radius: 50%; /* Make it circular */
            display: flex;    /* Center content */
            justify-content: center;
            align-items: center;
            font-size: 24px;  /* Icon size (adjust if using image/svg) */
            cursor: pointer;  /* Indicate clickable */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); /* Add shadow */
            transition: transform 0.2s ease-in-out; /* Add hover effect */
        }

        #chat-icon:hover {
            transform: scale(1.1); /* Slightly enlarge on hover */
        }

        /* --- Chat Window Styles (Initially Hidden) --- */
        #chat-window {
            display: none; /* Hide the chat window by default */
            position: fixed; /* Position relative to the viewport */
            bottom: 20px;
            right: 20px;
            width: 400px; /* Increased width */
            height: 500px; /* Default height */
            background-color: #f7fafc; /* Match original background */
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            flex-direction: column; /* Arrange content vertically */
            overflow: hidden; /* Hide overflow */
        }

        /* Styles for when the chat window is visible */
        #chatbot-widget-container.chat-open #chat-window {
            display: flex; /* Show the chat window when container has 'chat-open' class */
        }

         /* Styles for when the icon is hidden */
        #chatbot-widget-container.chat-open #chat-icon {
            display: none; /* Hide the icon when chat is open */
        }

        /* --- Chat Header (for close button) --- */
        #chat-header {
             padding: 0.5rem 1rem;
             background-color: #3b82f6; /* Header background */
             color: white;
             display: flex;
             justify-content: space-between;
             align-items: center;
             font-size: 1.1rem;
             font-weight: 600;
        }

        #chat-header h3 {
            margin: 0;
            font-size: 1.1rem; /* Match header font size */
        }


        #chat-close-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            margin-left: 10px; /* Space between title and close button */
        }

        #chat-close-button:hover {
            color: #e2e8f0; /* Lighten color on hover */
        }


        /* --- Existing Chat Container and Input Styles (Adjusted for new layout) --- */
        #chat_container {
            flex-grow: 1; /* Take available space */
            overflow-y: auto; /* Keep vertical scroll */
            padding: 1rem; /* Padding inside the chat area */
            display: flex;
            flex-direction: column;
            background-color: #f7fafc; /* Ensure background is set */
            /* Removed: height, max-width, margin, border, border-radius, box-shadow */
        }

        #input_container {
            display: flex;
            padding: 1rem; /* Padding around the input */
            background-color: #ffffff; /* White background for input area */
            border-top: 1px solid #e2e8f0; /* Separator line */
            /* Removed: margin, max-width, justify-content: center */
        }

        #user_input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem 0 0 0.5rem;
            margin-right: 0;
            font-size: 1rem;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

         #user_input:focus {
             outline: none;
             border-color: #3b82f6;
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
         }


        #send_button {
            padding: 0.75rem 1.5rem;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 0 0.5rem 0.5rem 0;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }

         #send_button:hover {
             background-color: #2563eb;
         }

         #send_button:focus {
             outline: none;
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
         }


        .message {
             margin-bottom: 1rem;
             display: flex;
             flex-direction: column;
             width: 100%; /* Ensure each message takes full width initially */
         }

         .sender {
             font-weight: 600;
             margin-right: 0.5rem;
         }

         .user {
             align-items: flex-end;
         }

         .agent {
             align-items: flex-start;
         }

         .message-content {
             padding: 0.75rem 1rem;
             border-radius: 0.5rem;
             max-width: 80%;
             white-space: pre-wrap; /* Allow wrapping of long text */
             overflow-x: auto; /* Enable horizontal scroll for content */
         }

         .user .message-content {
             background-color: #dcf8c6;
             color: #15803d;
             margin-left: auto;
         }

         .agent .message-content,
         .message.bot .message-content {
             background-color: #e0f2fe;
             color: #4b5563;
             margin-right: auto;
         }

         .typing-indicator {
             display: inline-flex;
             margin-left: 0.5rem;
         }

         .typing-indicator span {
             width: 0.5rem;
             height: 0.5rem;
             border-radius: 50%;
             background-color: #a0aec0;
             margin: 0 0.25rem;
             animation: pulse 1.5s infinite;
         }

         .typing-indicator span:nth-child(2) {
             animation-delay: 0.5s;
         }

         .typing-indicator span:nth-child(3) {
             animation-delay: 1s;
         }

         @keyframes pulse {
             0% {
                 opacity: 0.2;
             }
             50% {
                 opacity: 1;
             }
             100% {
                 opacity: 0.2;
             }
         }

        /* --- Responsive Adjustments --- */
        @media (max-width: 640px) {
             /* Make the chat window fill more of the screen on small devices */
            #chat-window {
                 bottom: 0;
                 right: 0;
                 width: 100%; /* Full width on small screens */
                 height: 100%; /* Full height on small screens */
                 border-radius: 0; /* No rounded corners when full screen */
             }

             /* Adjust padding for full screen on mobile */
            #chat_container {
                 padding: 0.5rem;
             }

            #input_container {
                 padding: 0.5rem;
             }

             /* Keep icon size the same */
            #chat-icon {
                 width: 50px;
                 height: 50px;
                 font-size: 20px;
                 bottom: 10px;
                 right: 10px;
             }

            /* Adjust margins for main content on mobile */
            .intro_text,
            .generative-ai-info {
                margin-left: 10px;
                margin-right: 10px; /* Reduce margin when chat is full screen */
                padding: 10px; /* Reduce padding */
            }
        }

         /* Adjust margins for main content when chat is open */
         @media (min-width: 641px) { /* Apply only on larger screens */
            #chatbot-widget-container.chat-open ~ .intro_text,
            #chatbot-widget-container.chat-open ~ .generative-ai-info {
                /* You might want to adjust content margins when the chat window is open
                   to prevent it from being obscured, though fixed positioning means
                   it overlays, it's good practice for larger content areas.
                   The current fixed positioning and size make this less critical,
                   but it's something to consider for layout harmony.
                   A simpler approach is often to just ensure the main content
                   doesn't get hidden, which fixed positioning helps with,
                   but margins on the main content prevent overlap issues
                   with the *closed* icon/widget area.
                */
                /* Example: add some padding to the bottom or right of content */
                 /* padding-right: calc(400px + 40px); /* Adjust based on new chat window width (400px) + margin (20px*2) */
            }
         }


    </style>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="intro_text">
        <h2>Virtual Agent Chatbot</h2>
        <br>
        <p>
            This is a simple chatbot page to act as a demo.
            <br><br>
            (<strong>Note</strong> - Answers may <em>not</em> always be correct)
        </p>
    </div>

    <div class="generative-ai-info">
        <h2>About This Chatbot Demo</h2>
        <p>
            This demo showcases a simple chatbot powered by a Generative AI model, utilizing the ChatGPT API. It's designed to illustrate how AI can be used for conversational interfaces and integrating with external data sources and APIs.
        </p>
        <br>
        <h2>Key Capabilities</h2>
        <p>This chatbot demo includes the following functionalities:</p>
        <ul>
            <li>Contextual Responses: It can answer questions based on specific topics by loading different knowledge contexts (e.g., information about TVR cars, Marcos cars, DevOps, CloudOps).</li>
            <li>GitHub Integration: It can interact with the GitHub API to perform tasks such as:
                <ul>
                    <li>Listing repositories, branches, and files.</li>
                    <li>Fetching files.</li>
                    <li>Creating pull requests.</li>
                    <li>Listing build jobs and commit history.</li>
                    <li>Downloading repository content.</li>
                </ul>
            </li>
            <li>Automated Code Review: Leverages AI to perform code reviews from GitHub repositories, offering suggestions for general improvements, security, efficiency, formatting, and documentation.</li>
            <li>DOSA API Interaction: Can query the DOSA MOT history database to provide information like MOT history and defect details for specific cars.</li>
        </ul>
        <p>
            Explore these capabilities by interacting with the chatbot! Remember that while powerful, AI responses should always be reviewed, especially for critical information or actions.
        </p>
    </div>
    <div id="chatbot-widget-container" class="chat-closed">
        <div id="chat-icon">
            💬
        </div>

        <div id="chat-window">
             <div id="chat-header">
                 <h3>Chatbot</h3>
                 <button id="chat-close-button">&times;</button> </div>

             <div id="chat_container">
                 </div>

             <div id="input_container">
                 <input type="text" id="user_input" placeholder="Type your message..."
                     class="flex-grow border rounded-md focus:ring-2 focus:ring-blue-500">
                 <button id="send_button"
                     class="bg-blue-500 hover:bg-blue-700 text-white font-bold rounded-md focus:outline-none focus:shadow-outline">Send</button>
             </div>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat_container');
        const userInput = document.getElementById('user_input');
        const sendButton = document.getElementById('send_button');

        // New elements for the floating widget
        const chatbotWidgetContainer = document.getElementById('chatbot-widget-container');
        const chatIcon = document.getElementById('chat-icon');
        const chatCloseButton = document.getElementById('chat-close-button');
        const chatWindow = document.getElementById('chat-window');

        // Function to open the chat window
        function openChat() {
            chatbotWidgetContainer.classList.remove('chat-closed');
            chatbotWidgetContainer.classList.add('chat-open');
             // Optional: focus on the input field when opening
             userInput.focus();
        }

        // Function to close the chat window
        function closeChat() {
            chatbotWidgetContainer.classList.remove('chat-open');
            chatbotWidgetContainer.classList.add('chat-closed');
        }


        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') {
                return;
            }
            appendMessage('User', message);
            userInput.value = '';
            userInput.disabled = true;
            sendButton.disabled = true;
            chatContainer.style.cursor = "wait"; // Indicate processing

            appendTypingIndicator();
            // getResponse is the function that talks to your backend
            getResponse(message).then(response => {
                 removeTypingIndicator();
                 // Ensure response is a string or handle other types if necessary
                 const botMessage = (typeof response === 'object' && response !== null) ? JSON.stringify(response, null, 2) : String(response);
                 appendMessage('Bot', botMessage);
                 chatContainer.style.cursor = ""; // Reset cursor
                 userInput.disabled = false;
                 sendButton.disabled = false;
                 userInput.focus(); // Keep focus on input after response
            }).catch(error => {
                 removeTypingIndicator();
                 console.error("Error getting response:", error);
                 appendMessage('Bot', "Sorry, there was an error getting a response.");
                 chatContainer.style.cursor = "";
                 userInput.disabled = false;
                 sendButton.disabled = false;
                 userInput.focus();
            });
        }

        function appendMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender.toLowerCase());

            const senderSpan = document.createElement('span');
            senderSpan.classList.add('sender', 'text-gray-600');
            senderSpan.textContent = sender + ':';

            const messageContentDiv = document.createElement('div');
            messageContentDiv.classList.add('message-content');

            let dataApp = message;

            if (sender === 'Bot') {
                // Ensure bot message is a string before passing to marked
                 dataApp = String(message);
                // Use marked for Markdown parsing
                const mStr = marked.parse(dataApp);
                // Remove potential leading/trailing empty lines from marked output
                 messageContentDiv.innerHTML = mStr.replace(/(^\s*<p>\s*<\/p>\s*)|(\s*<p>\s*<\/p>\s*$)/g, "").trim();

            } else {
                 // For user messages, just set text content to prevent XSS
                 messageContentDiv.textContent = message;
            }

            // For 'user' messages, the sender label is usually omitted or placed differently.
            // Based on current CSS alignment, appending senderSpan is fine, but you might
            // want to adjust its display or order based on the sender class if needed.
            // messageElement.appendChild(senderSpan); // Optional: keep sender label for user
            messageElement.appendChild(messageContentDiv);

             // Adjust message bubble alignment based on sender
             if (sender.toLowerCase() === 'user') {
                 messageElement.style.alignSelf = 'flex-end';
             } else { // Bot or Agent
                 messageElement.style.alignSelf = 'flex-start';
             }


            chatContainer.appendChild(messageElement);
            // Scroll to the bottom after adding a message
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

         function appendTypingIndicator() {
             // Remove any existing typing indicator first
             removeTypingIndicator();

             const typingIndicator = document.createElement('div');
             typingIndicator.classList.add('message', 'agent', 'typing-indicator-container'); // Add a class to easily find it

             const indicatorDiv = document.createElement('div');
             indicatorDiv.classList.add('typing-indicator');
             for (let i = 0; i < 3; i++) {
                 const dotSpan = document.createElement('span');
                 indicatorDiv.appendChild(dotSpan);
             }

             typingIndicator.appendChild(indicatorDiv);
             chatContainer.appendChild(typingIndicator);
             chatContainer.scrollTop = chatContainer.scrollHeight;
         }

        function removeTypingIndicator() {
            const typingIndicator = chatContainer.querySelector('.typing-indicator-container'); // Use the specific class
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }


        async function getResponse(userMessage) {
            // This function makes the API call to your backend
            try {
                const response = await fetch("/chat", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ message: userMessage }),
                    credentials: 'include' // Include cookies for session
                });

                if (!response.ok) {
                    // Log the error response body if available
                     const errorBody = await response.text();
                     console.error(`Server error: ${response.status}`, errorBody);
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                if (data && data.response !== undefined) { // Check for undefined explicitly
                    return data.response;
                } else {
                    console.error("Invalid response format:", data);
                    return "The server returned an invalid response."
                }
            } catch (err) {
                console.error("Fetch error:", err);
                return "Could not connect to the server or an error occurred.";
            }
        }

        // Event Listeners for the widget toggle
        chatIcon.addEventListener('click', openChat);
        chatCloseButton.addEventListener('click', closeChat);

        // Event Listeners for the chat input
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission
                sendMessage();
            }
        });
        sendButton.addEventListener('click', sendMessage);

        // Add an initial message *after* the user opens the chat for the first time
        let initialMessageShown = false;
        function showInitialMessageOnce() {
             if (!initialMessageShown) {
                 appendMessage('Bot', 'Hello! How can I help you today?');
                 initialMessageShown = true;
             }
        }
        // Call this when the chat is opened
        chatIcon.addEventListener('click', showInitialMessageOnce);


    </script>
</body>
</html>